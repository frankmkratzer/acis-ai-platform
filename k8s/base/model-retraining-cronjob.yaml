apiVersion: batch/v1
kind: CronJob
metadata:
  name: model-drift-check
  namespace: acis-ai
  labels:
    app: model-drift-check
    component: mlops
spec:
  # Run daily at 3 AM UTC
  schedule: "0 3 * * *"
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: model-drift-check
        spec:
          restartPolicy: OnFailure
          containers:
          - name: drift-check
            image: acis-ai-backend:latest
            env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: acis-secrets
                  key: database-url
            - name: MLFLOW_TRACKING_URI
              value: "http://mlflow:5000"
            - name: PYTHONPATH
              value: "/app"
            command:
            - python
            - /app/mlops/retraining/auto_retrain.py
            - --drift-threshold
            - "0.3"
            - --min-accuracy
            - "0.7"
            resources:
              requests:
                memory: "1Gi"
                cpu: "500m"
              limits:
                memory: "4Gi"
                cpu: "2000m"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: weekly-model-retrain
  namespace: acis-ai
  labels:
    app: weekly-model-retrain
    component: mlops
spec:
  # Run weekly on Sunday at 4 AM UTC
  schedule: "0 4 * * 0"
  successfulJobsHistoryLimit: 4
  failedJobsHistoryLimit: 2
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: weekly-model-retrain
        spec:
          restartPolicy: OnFailure
          containers:
          - name: retrain
            image: acis-ai-backend:latest
            env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: acis-secrets
                  key: database-url
            - name: MLFLOW_TRACKING_URI
              value: "http://mlflow:5000"
            - name: PYTHONPATH
              value: "/app"
            command:
            - sh
            - -c
            - |
              # Force retrain all strategies weekly
              for strategy in growth value dividend momentum; do
                echo "Training $strategy strategy..."
                python /app/mlops/mlflow/train_with_mlflow.py --strategy $strategy --promote
              done
            resources:
              requests:
                memory: "2Gi"
                cpu: "1000m"
              limits:
                memory: "8Gi"
                cpu: "4000m"
